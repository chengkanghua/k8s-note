

# 问题 configmap secret 都有。为什么myblog 获取不到？

```bash
[root@k8s-master two-pod]# kubectl -n luffy get po
NAME                      READY   STATUS    RESTARTS   AGE
myblog-7fd5c8676f-9pd6r   0/1     Running   7          11m
mysql                     1/1     Running   0          11m
[root@k8s-master two-pod]# kubectl -n luffy get deploy
NAME     READY   UP-TO-DATE   AVAILABLE   AGE
myblog   0/1     1            0           11m
[root@k8s-master two-pod]# kubectl -n luffy delete deploy myblog
deployment.apps "myblog" deleted
[root@k8s-master two-pod]#
[root@k8s-master two-pod]#
[root@k8s-master two-pod]# kubectl -n luffy get deploy
No resources found in luffy namespace.
[root@k8s-master two-pod]# kubectl -n luffy get deploy
NAME     READY   UP-TO-DATE   AVAILABLE   AGE
myblog   0/1     1            0           15s
[root@k8s-master two-pod]# kubectl -n luffy get po
NAME                      READY   STATUS    RESTARTS   AGE
myblog-565ffc8758-tmsc2   0/1     Running   0          20s
mysql                     1/1     Running   0          14m
[root@k8s-master two-pod]# kubectl -n luffy describe po myblog-565ffc8758-tmsc2
Name:         myblog-565ffc8758-tmsc2
Namespace:    luffy
Priority:     0
Node:         k8s-slave2/10.211.55.27
Start Time:   Sat, 29 Oct 2022 15:01:08 +0800
Labels:       app=myblog
              pod-template-hash=565ffc8758
Annotations:  <none>
Status:       Running
IP:           10.244.2.134
IPs:
  IP:           10.244.2.134
Controlled By:  ReplicaSet/myblog-565ffc8758
Containers:
  myblog:
    Container ID:   docker://4cf8e1e992e462d0a6bdda8104953d6f0d502c9c025651b0cc6c00d90b9169e7
    Image:          10.211.55.27:5000/myblog:471212138db22a34096923eb945bb8f2a23faa54
    Image ID:       docker-pullable://10.211.55.27:5000/myblog@sha256:d7de7ebd424f29dd5d3c9145b3dc4c72d97d6ca2ad6811abe8505de6dd11d919
    Port:           8002/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Sat, 29 Oct 2022 15:01:09 +0800
    Ready:          False
    Restart Count:  0
    Limits:
      cpu:     100m
      memory:  500Mi
    Requests:
      cpu:      50m
      memory:   100Mi
    Liveness:   http-get http://:8002/blog/index/ delay=10s timeout=2s period=15s #success=1 #failure=3
    Readiness:  http-get http://:8002/blog/index/ delay=10s timeout=2s period=15s #success=1 #failure=3
    Environment:
      MYSQL_HOST:    <set to the key 'MYSQL_HOST' of config map 'myblog'>  Optional: false  #为啥获取不到
      MYSQL_PORT:    <set to the key 'MYSQL_PORT' of config map 'myblog'>  Optional: false
      MYSQL_USER:    <set to the key 'MYSQL_USER' in secret 'myblog'>      Optional: false
      MYSQL_PASSWD:  <set to the key 'MYSQL_PASSWD' in secret 'myblog'>    Optional: false
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-gcmfg (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             False
  ContainersReady   False
  PodScheduled      True
Volumes:
  kube-api-access-gcmfg:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   Burstable
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason     Age               From               Message
  ----     ------     ----              ----               -------
  Normal   Scheduled  33s               default-scheduler  Successfully assigned luffy/myblog-565ffc8758-tmsc2 to k8s-slave2
  Normal   Pulled     30s               kubelet            Container image "10.211.55.27:5000/myblog:471212138db22a34096923eb945bb8f2a23faa54" already present on machine
  Normal   Created    30s               kubelet            Created container myblog
  Normal   Started    30s               kubelet            Started container myblog
  Warning  Unhealthy  0s (x2 over 14s)  kubelet            Liveness probe failed: Get "http://10.244.2.134:8002/blog/index/": context deadline exceeded (Client.Timeout exceeded while awaiting headers)
  Warning  Unhealthy  0s (x2 over 14s)  kubelet            Readiness probe failed: Get "http://10.244.2.134:8002/blog/index/": context deadline exceeded (Client.Timeout exceeded while awaiting headers)
[root@k8s-master two-pod]# kubectl -n luffy get cm
kube-root-ca.crt  myblog
[root@k8s-master two-pod]# kubectl -n luffy get cm myblog
NAME     DATA   AGE
myblog   2      18d
[root@k8s-master two-pod]# kubectl -n luffy get cm myblog -oyaml
apiVersion: v1
data:
  MYSQL_HOST: mysql
  MYSQL_PORT: "3306"
kind: ConfigMap
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"MYSQL_HOST":"mysql","MYSQL_PORT":"3306"},"kind":"ConfigMap","metadata":{"annotations":{},"name":"myblog","namespace":"luffy"}}
  creationTimestamp: "2022-10-11T04:04:58Z"
  name: myblog
  namespace: luffy
  resourceVersion: "247927"
  selfLink: /api/v1/namespaces/luffy/configmaps/myblog
  uid: 2364eccc-33e0-4910-967b-e58c3e5de282
[root@k8s-master two-pod]# kubectl -n luffy get secret myblog -oyaml
apiVersion: v1
data:
  MYSQL_PASSWD: MTIzNDU2
  MYSQL_USER: cm9vdA==
kind: Secret
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"MYSQL_PASSWD":"MTIzNDU2","MYSQL_USER":"cm9vdA=="},"kind":"Secret","metadata":{"annotations":{},"name":"myblog","namespace":"luffy"},"type":"Opaque"}
  creationTimestamp: "2022-10-11T04:16:42Z"
  name: myblog
  namespace: luffy
  resourceVersion: "231980"
  selfLink: /api/v1/namespaces/luffy/secrets/myblog
  uid: df207f49-5bda-48da-9044-f86b7eb7d1f7
type: Opaque
```







完整的 yaml文件

```bah

[root@k8s-master deployment]# cat myblog_all.yaml
apiVersion: v1
kind: Secret
metadata:
  name: myblog
  namespace: luffy
type: Opaque
data:
  MYSQL_USER: cm9vdA==
  MYSQL_PASSWD: MTIzNDU2
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: myblog
  namespace: luffy
data:
  MYSQL_HOST: "mysql"
  MYSQL_PORT: "3306"
---
apiVersion: v1
kind: Pod
metadata:
  name: mysql
  namespace: luffy
  labels:
    component: mysql
spec:
  hostNetwork: true
  volumes:
  - name: mysql-data
    hostPath:
      path: /opt/mysql/data
  nodeSelector:
    component: mysql
  containers:
  - name: mysql
    image: mysql:5.7
    args:
    - --character-set-server=utf8mb4
    - --collation-server=utf8mb4_unicode_ci
    ports:
    - containerPort: 3306
    env:
    - name: MYSQL_USER
      valueFrom:
        secretKeyRef:
          name: myblog
          key: MYSQL_USER
    - name: MYSQL_ROOT_PASSWORD
      valueFrom:
        secretKeyRef:
          name: myblog
          key: MYSQL_PASSWD
    - name: MYSQL_DATABASE
      value: "myblog"
    resources:
      requests:
        memory: 100Mi
        cpu: 50m
      limits:
        memory: 500Mi
        cpu: 100m
    readinessProbe:
      tcpSocket:
        port: 3306
      initialDelaySeconds: 5
      periodSeconds: 10
    livenessProbe:
      tcpSocket:
        port: 3306
      initialDelaySeconds: 15
      periodSeconds: 20
    volumeMounts:
    - name: mysql-data
      mountPath: /var/lib/mysql
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myblog
  namespace: luffy
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myblog
  template:
    metadata:
      labels:
        app: myblog
    spec:
      containers:
      - name: myblog
        image: {{IMAGE_URL}}
        imagePullPolicy: IfNotPresent
        env:
        - name: MYSQL_HOST
          valueFrom:
            configMapKeyRef:
              name: myblog
              key: MYSQL_HOST
        - name: MYSQL_PORT
          valueFrom:
            configMapKeyRef:
              name: myblog
              key: MYSQL_PORT
        - name: MYSQL_USER
          valueFrom:
            secretKeyRef:
              name: myblog
              key: MYSQL_USER
        - name: MYSQL_PASSWD
          valueFrom:
            secretKeyRef:
              name: myblog
              key: MYSQL_PASSWD
        ports:
        - containerPort: 8002
        resources:
          requests:
            memory: 100Mi
            cpu: 50m
          limits:
            memory: 500Mi
            cpu: 100m
        livenessProbe:
          httpGet:
            path: /blog/index/
            port: 8002
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 15
          timeoutSeconds: 2
        readinessProbe:
          httpGet:
            path: /blog/index/
            port: 8002
            scheme: HTTP
          initialDelaySeconds: 10
          timeoutSeconds: 2
          periodSeconds: 15
```

